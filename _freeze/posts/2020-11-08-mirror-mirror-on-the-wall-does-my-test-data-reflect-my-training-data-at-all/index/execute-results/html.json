{
  "hash": "c04199ded25a2b02447fae35bd68e08c",
  "result": {
    "markdown": "---\ntitle: 'Mirror, mirror on the wall, does my test data reflect my training data at all?'\nauthor: Amanda Peterson\ndate: '2020-11-08'\ndescription: A closer look at the train-test split \ntags: [ML, rstats]\ndraft: false\ncode-copy: true\nimage: mirror_cartoon.jpg\n---\n\n\n\n\nIn the paper [Are We Really Making Much Progress? A Worrying Analysis of Recent Neural Recommendation Approaches](https://arxiv.org/pdf/1907.06902.pdf){target=\"_blank\"}, authors Dacrema, Cremonesi, and Jannach evaluate various neural networks which were designed for recommendation systems and proposed in prominent machine learning journals. A recommendation system is an information filtering system which uses user history (e.g. purchases, page views, clicks, thumbs up/down, etc) to provide personalized item recommendations to users.\n\nThe authors point out a few mistakes or \"questionable techniques\" used in the research they were attempting to reproduce and evaluate. The figure in the article snippet below points out that, for a particular model they were evaluating, the popularity distribution of items assigned to the test and train data splits did not seem to be the same. *Interestingly, this affected the reported results and potentially the claim that the proposed model was a state-of-the-art!* See the article for more details.\n\n------------------------------------------------------------------------\n\n\n![](images/para1.png){width=\"48%\" fig-align='center'}\n![](images/para2.png){width=\"48%\" fig-align='center'}\n\nSnippet of the 2020 paper, \"Are We Really Making Much Progress? A Worrying Analysis of Recent Neural Recommendation Approaches\", by Dacrema, Cremonesi, and Jannach\n\n\n------------------------------------------------------------------------\n\nI thought this was a nice example comparing the distribution of two samples (i.e. comparing the item popularity of the test set versus the training set). Why is this important? Well, because we would like to train our model using data similar to data that the model will score in the future. The test set is used to tell us how good (or bad) our model performs on data that it has not seen before.\n\nThe authors mentioned that they used the Gini index to evaluate the distribution of the test set. One might also wonder if a hypothesis test could be used to consider the evidence for or against the training and test sets having the same underlying distribution. Let's look at both approaches.\n\n\n\n\n\n\n\n## The data\n\nThe train and test data mentioned in the article above are available at [github.com/lzheng21/SpectralCF](https://github.com/lzheng21/SpectralCF/tree/master/data/ml-1m){target=\"_blank\"}. For convenience I also saved them as R dataframes in the [data directory](https://github.com/AmandaRP/AmandaRP.github.io/tree/master/content/post/2020-11-08-mirror-mirror-on-the-wall-does-my-test-data-reflect-my-training-data-at-all/data){target=\"_blank\"} of the GitHub repo associated with this analysis. Using R, the data can be loaded as follows.\n\n\n::: {.cell code-copy='true'}\n\n```{.r .fold-show .cell-code}\nload(\"data/train_test.RData\")\n```\n:::\n\n\nLet's take a peek at the training set. The data is composed of two columns containing user ids and item ids. It comes from [MovieLens](https://grouplens.org/datasets/movielens/){target=\"_blank\"}, which provides data about movie watching history. The existence of a user-item pair in the data means that the user interacted with the item (in this case the user watched the movie). A data scientist can use this information as \"implicit feedback\", inferring that the user \"liked\" the item.\n\n\n::: {.cell}\n::: {.cell-output-display}\n```{=html}\n<div id=\"deeaywrwuj\" style=\"padding-left:0px;padding-right:0px;padding-top:10px;padding-bottom:10px;overflow-x:auto;overflow-y:auto;width:auto;height:auto;\">\n<style>html {\n  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Helvetica Neue', 'Fira Sans', 'Droid Sans', Arial, sans-serif;\n}\n\n#deeaywrwuj .gt_table {\n  display: table;\n  border-collapse: collapse;\n  margin-left: auto;\n  margin-right: auto;\n  color: #333333;\n  font-size: 16px;\n  font-weight: normal;\n  font-style: normal;\n  background-color: #FFFFFF;\n  width: auto;\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #A8A8A8;\n  border-right-style: none;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #A8A8A8;\n  border-left-style: none;\n  border-left-width: 2px;\n  border-left-color: #D3D3D3;\n}\n\n#deeaywrwuj .gt_heading {\n  background-color: #FFFFFF;\n  text-align: center;\n  border-bottom-color: #FFFFFF;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n}\n\n#deeaywrwuj .gt_caption {\n  padding-top: 4px;\n  padding-bottom: 4px;\n}\n\n#deeaywrwuj .gt_title {\n  color: #333333;\n  font-size: 125%;\n  font-weight: initial;\n  padding-top: 4px;\n  padding-bottom: 4px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-bottom-color: #FFFFFF;\n  border-bottom-width: 0;\n}\n\n#deeaywrwuj .gt_subtitle {\n  color: #333333;\n  font-size: 85%;\n  font-weight: initial;\n  padding-top: 0;\n  padding-bottom: 6px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-top-color: #FFFFFF;\n  border-top-width: 0;\n}\n\n#deeaywrwuj .gt_bottom_border {\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n}\n\n#deeaywrwuj .gt_col_headings {\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n}\n\n#deeaywrwuj .gt_col_heading {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: normal;\n  text-transform: inherit;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n  vertical-align: bottom;\n  padding-top: 5px;\n  padding-bottom: 6px;\n  padding-left: 5px;\n  padding-right: 5px;\n  overflow-x: hidden;\n}\n\n#deeaywrwuj .gt_column_spanner_outer {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: normal;\n  text-transform: inherit;\n  padding-top: 0;\n  padding-bottom: 0;\n  padding-left: 4px;\n  padding-right: 4px;\n}\n\n#deeaywrwuj .gt_column_spanner_outer:first-child {\n  padding-left: 0;\n}\n\n#deeaywrwuj .gt_column_spanner_outer:last-child {\n  padding-right: 0;\n}\n\n#deeaywrwuj .gt_column_spanner {\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  vertical-align: bottom;\n  padding-top: 5px;\n  padding-bottom: 5px;\n  overflow-x: hidden;\n  display: inline-block;\n  width: 100%;\n}\n\n#deeaywrwuj .gt_group_heading {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  text-transform: inherit;\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n  vertical-align: middle;\n  text-align: left;\n}\n\n#deeaywrwuj .gt_empty_group_heading {\n  padding: 0.5px;\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  vertical-align: middle;\n}\n\n#deeaywrwuj .gt_from_md > :first-child {\n  margin-top: 0;\n}\n\n#deeaywrwuj .gt_from_md > :last-child {\n  margin-bottom: 0;\n}\n\n#deeaywrwuj .gt_row {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  margin: 10px;\n  border-top-style: solid;\n  border-top-width: 1px;\n  border-top-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n  vertical-align: middle;\n  overflow-x: hidden;\n}\n\n#deeaywrwuj .gt_stub {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  text-transform: inherit;\n  border-right-style: solid;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#deeaywrwuj .gt_stub_row_group {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  text-transform: inherit;\n  border-right-style: solid;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n  padding-left: 5px;\n  padding-right: 5px;\n  vertical-align: top;\n}\n\n#deeaywrwuj .gt_row_group_first td {\n  border-top-width: 2px;\n}\n\n#deeaywrwuj .gt_summary_row {\n  color: #333333;\n  background-color: #FFFFFF;\n  text-transform: inherit;\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#deeaywrwuj .gt_first_summary_row {\n  border-top-style: solid;\n  border-top-color: #D3D3D3;\n}\n\n#deeaywrwuj .gt_first_summary_row.thick {\n  border-top-width: 2px;\n}\n\n#deeaywrwuj .gt_last_summary_row {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n}\n\n#deeaywrwuj .gt_grand_summary_row {\n  color: #333333;\n  background-color: #FFFFFF;\n  text-transform: inherit;\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#deeaywrwuj .gt_first_grand_summary_row {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-top-style: double;\n  border-top-width: 6px;\n  border-top-color: #D3D3D3;\n}\n\n#deeaywrwuj .gt_striped {\n  background-color: rgba(128, 128, 128, 0.05);\n}\n\n#deeaywrwuj .gt_table_body {\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n}\n\n#deeaywrwuj .gt_footnotes {\n  color: #333333;\n  background-color: #FFFFFF;\n  border-bottom-style: none;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 2px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n}\n\n#deeaywrwuj .gt_footnote {\n  margin: 0px;\n  font-size: 90%;\n  padding-left: 4px;\n  padding-right: 4px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#deeaywrwuj .gt_sourcenotes {\n  color: #333333;\n  background-color: #FFFFFF;\n  border-bottom-style: none;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 2px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n}\n\n#deeaywrwuj .gt_sourcenote {\n  font-size: 90%;\n  padding-top: 4px;\n  padding-bottom: 4px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#deeaywrwuj .gt_left {\n  text-align: left;\n}\n\n#deeaywrwuj .gt_center {\n  text-align: center;\n}\n\n#deeaywrwuj .gt_right {\n  text-align: right;\n  font-variant-numeric: tabular-nums;\n}\n\n#deeaywrwuj .gt_font_normal {\n  font-weight: normal;\n}\n\n#deeaywrwuj .gt_font_bold {\n  font-weight: bold;\n}\n\n#deeaywrwuj .gt_font_italic {\n  font-style: italic;\n}\n\n#deeaywrwuj .gt_super {\n  font-size: 65%;\n}\n\n#deeaywrwuj .gt_footnote_marks {\n  font-style: italic;\n  font-weight: normal;\n  font-size: 75%;\n  vertical-align: 0.4em;\n}\n\n#deeaywrwuj .gt_asterisk {\n  font-size: 100%;\n  vertical-align: 0;\n}\n\n#deeaywrwuj .gt_indent_1 {\n  text-indent: 5px;\n}\n\n#deeaywrwuj .gt_indent_2 {\n  text-indent: 10px;\n}\n\n#deeaywrwuj .gt_indent_3 {\n  text-indent: 15px;\n}\n\n#deeaywrwuj .gt_indent_4 {\n  text-indent: 20px;\n}\n\n#deeaywrwuj .gt_indent_5 {\n  text-indent: 25px;\n}\n</style>\n<table class=\"gt_table\">\n  <thead class=\"gt_header\">\n    <tr>\n      <td colspan=\"2\" class=\"gt_heading gt_title gt_font_normal gt_bottom_border\" style>Sample of Training Data</td>\n    </tr>\n    \n  </thead>\n  <thead class=\"gt_col_headings\">\n    <tr>\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_right\" rowspan=\"1\" colspan=\"1\" scope=\"col\" id=\"user\">user</th>\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_right\" rowspan=\"1\" colspan=\"1\" scope=\"col\" id=\"item\">item</th>\n    </tr>\n  </thead>\n  <tbody class=\"gt_table_body\">\n    <tr><td headers=\"user\" class=\"gt_row gt_right\">3798</td>\n<td headers=\"item\" class=\"gt_row gt_right\">797</td></tr>\n    <tr><td headers=\"user\" class=\"gt_row gt_right\">3665</td>\n<td headers=\"item\" class=\"gt_row gt_right\">2343</td></tr>\n    <tr><td headers=\"user\" class=\"gt_row gt_right\">3058</td>\n<td headers=\"item\" class=\"gt_row gt_right\">827</td></tr>\n    <tr><td headers=\"user\" class=\"gt_row gt_right\">1221</td>\n<td headers=\"item\" class=\"gt_row gt_right\">2483</td></tr>\n    <tr><td headers=\"user\" class=\"gt_row gt_right\">2869</td>\n<td headers=\"item\" class=\"gt_row gt_right\">1236</td></tr>\n  </tbody>\n  \n  \n</table>\n</div>\n```\n:::\n:::\n\n::: {.cell}\n::: {.cell-output-display}\n```{=html}\n<div id=\"kdjodzchbm\" style=\"padding-left:0px;padding-right:0px;padding-top:10px;padding-bottom:10px;overflow-x:auto;overflow-y:auto;width:auto;height:auto;\">\n<style>html {\n  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Helvetica Neue', 'Fira Sans', 'Droid Sans', Arial, sans-serif;\n}\n\n#kdjodzchbm .gt_table {\n  display: table;\n  border-collapse: collapse;\n  margin-left: auto;\n  margin-right: auto;\n  color: #333333;\n  font-size: 16px;\n  font-weight: normal;\n  font-style: normal;\n  background-color: #FFFFFF;\n  width: auto;\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #A8A8A8;\n  border-right-style: none;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #A8A8A8;\n  border-left-style: none;\n  border-left-width: 2px;\n  border-left-color: #D3D3D3;\n}\n\n#kdjodzchbm .gt_heading {\n  background-color: #FFFFFF;\n  text-align: center;\n  border-bottom-color: #FFFFFF;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n}\n\n#kdjodzchbm .gt_caption {\n  padding-top: 4px;\n  padding-bottom: 4px;\n}\n\n#kdjodzchbm .gt_title {\n  color: #333333;\n  font-size: 125%;\n  font-weight: initial;\n  padding-top: 4px;\n  padding-bottom: 4px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-bottom-color: #FFFFFF;\n  border-bottom-width: 0;\n}\n\n#kdjodzchbm .gt_subtitle {\n  color: #333333;\n  font-size: 85%;\n  font-weight: initial;\n  padding-top: 0;\n  padding-bottom: 6px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-top-color: #FFFFFF;\n  border-top-width: 0;\n}\n\n#kdjodzchbm .gt_bottom_border {\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n}\n\n#kdjodzchbm .gt_col_headings {\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n}\n\n#kdjodzchbm .gt_col_heading {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: normal;\n  text-transform: inherit;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n  vertical-align: bottom;\n  padding-top: 5px;\n  padding-bottom: 6px;\n  padding-left: 5px;\n  padding-right: 5px;\n  overflow-x: hidden;\n}\n\n#kdjodzchbm .gt_column_spanner_outer {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: normal;\n  text-transform: inherit;\n  padding-top: 0;\n  padding-bottom: 0;\n  padding-left: 4px;\n  padding-right: 4px;\n}\n\n#kdjodzchbm .gt_column_spanner_outer:first-child {\n  padding-left: 0;\n}\n\n#kdjodzchbm .gt_column_spanner_outer:last-child {\n  padding-right: 0;\n}\n\n#kdjodzchbm .gt_column_spanner {\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  vertical-align: bottom;\n  padding-top: 5px;\n  padding-bottom: 5px;\n  overflow-x: hidden;\n  display: inline-block;\n  width: 100%;\n}\n\n#kdjodzchbm .gt_group_heading {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  text-transform: inherit;\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n  vertical-align: middle;\n  text-align: left;\n}\n\n#kdjodzchbm .gt_empty_group_heading {\n  padding: 0.5px;\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  vertical-align: middle;\n}\n\n#kdjodzchbm .gt_from_md > :first-child {\n  margin-top: 0;\n}\n\n#kdjodzchbm .gt_from_md > :last-child {\n  margin-bottom: 0;\n}\n\n#kdjodzchbm .gt_row {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  margin: 10px;\n  border-top-style: solid;\n  border-top-width: 1px;\n  border-top-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n  vertical-align: middle;\n  overflow-x: hidden;\n}\n\n#kdjodzchbm .gt_stub {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  text-transform: inherit;\n  border-right-style: solid;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#kdjodzchbm .gt_stub_row_group {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  text-transform: inherit;\n  border-right-style: solid;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n  padding-left: 5px;\n  padding-right: 5px;\n  vertical-align: top;\n}\n\n#kdjodzchbm .gt_row_group_first td {\n  border-top-width: 2px;\n}\n\n#kdjodzchbm .gt_summary_row {\n  color: #333333;\n  background-color: #FFFFFF;\n  text-transform: inherit;\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#kdjodzchbm .gt_first_summary_row {\n  border-top-style: solid;\n  border-top-color: #D3D3D3;\n}\n\n#kdjodzchbm .gt_first_summary_row.thick {\n  border-top-width: 2px;\n}\n\n#kdjodzchbm .gt_last_summary_row {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n}\n\n#kdjodzchbm .gt_grand_summary_row {\n  color: #333333;\n  background-color: #FFFFFF;\n  text-transform: inherit;\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#kdjodzchbm .gt_first_grand_summary_row {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-top-style: double;\n  border-top-width: 6px;\n  border-top-color: #D3D3D3;\n}\n\n#kdjodzchbm .gt_striped {\n  background-color: rgba(128, 128, 128, 0.05);\n}\n\n#kdjodzchbm .gt_table_body {\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n}\n\n#kdjodzchbm .gt_footnotes {\n  color: #333333;\n  background-color: #FFFFFF;\n  border-bottom-style: none;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 2px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n}\n\n#kdjodzchbm .gt_footnote {\n  margin: 0px;\n  font-size: 90%;\n  padding-left: 4px;\n  padding-right: 4px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#kdjodzchbm .gt_sourcenotes {\n  color: #333333;\n  background-color: #FFFFFF;\n  border-bottom-style: none;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 2px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n}\n\n#kdjodzchbm .gt_sourcenote {\n  font-size: 90%;\n  padding-top: 4px;\n  padding-bottom: 4px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#kdjodzchbm .gt_left {\n  text-align: left;\n}\n\n#kdjodzchbm .gt_center {\n  text-align: center;\n}\n\n#kdjodzchbm .gt_right {\n  text-align: right;\n  font-variant-numeric: tabular-nums;\n}\n\n#kdjodzchbm .gt_font_normal {\n  font-weight: normal;\n}\n\n#kdjodzchbm .gt_font_bold {\n  font-weight: bold;\n}\n\n#kdjodzchbm .gt_font_italic {\n  font-style: italic;\n}\n\n#kdjodzchbm .gt_super {\n  font-size: 65%;\n}\n\n#kdjodzchbm .gt_footnote_marks {\n  font-style: italic;\n  font-weight: normal;\n  font-size: 75%;\n  vertical-align: 0.4em;\n}\n\n#kdjodzchbm .gt_asterisk {\n  font-size: 100%;\n  vertical-align: 0;\n}\n\n#kdjodzchbm .gt_indent_1 {\n  text-indent: 5px;\n}\n\n#kdjodzchbm .gt_indent_2 {\n  text-indent: 10px;\n}\n\n#kdjodzchbm .gt_indent_3 {\n  text-indent: 15px;\n}\n\n#kdjodzchbm .gt_indent_4 {\n  text-indent: 20px;\n}\n\n#kdjodzchbm .gt_indent_5 {\n  text-indent: 25px;\n}\n</style>\n<table class=\"gt_table\">\n  <thead class=\"gt_header\">\n    <tr>\n      <td colspan=\"6\" class=\"gt_heading gt_title gt_font_normal gt_bottom_border\" style>Summary of Training Data</td>\n    </tr>\n    \n  </thead>\n  <thead class=\"gt_col_headings\">\n    <tr>\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_right\" rowspan=\"1\" colspan=\"1\" scope=\"col\" id=\"Min User ID\">Min User ID</th>\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_right\" rowspan=\"1\" colspan=\"1\" scope=\"col\" id=\"Max User ID\">Max User ID</th>\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_right\" rowspan=\"1\" colspan=\"1\" scope=\"col\" id=\"User Count\">User Count</th>\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_right\" rowspan=\"1\" colspan=\"1\" scope=\"col\" id=\"Min Item ID\">Min Item ID</th>\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_right\" rowspan=\"1\" colspan=\"1\" scope=\"col\" id=\"Max Item ID\">Max Item ID</th>\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_right\" rowspan=\"1\" colspan=\"1\" scope=\"col\" id=\"Item Count\">Item Count</th>\n    </tr>\n  </thead>\n  <tbody class=\"gt_table_body\">\n    <tr><td headers=\"min_user\" class=\"gt_row gt_right\">0</td>\n<td headers=\"max_user\" class=\"gt_row gt_right\">6013</td>\n<td headers=\"num_users\" class=\"gt_row gt_right\">6014</td>\n<td headers=\"min_item\" class=\"gt_row gt_right\">0</td>\n<td headers=\"max_item\" class=\"gt_row gt_right\">3704</td>\n<td headers=\"num_items\" class=\"gt_row gt_right\">3068</td></tr>\n  </tbody>\n  \n  \n</table>\n</div>\n```\n:::\n:::\n\n\nNext, count the number of user interactions per item in each of the train and test datasets. Only the first 6 rows of the result are shown in the table below.\n\n\n::: {.cell code-copy='true'}\n\n```{.r .fold-show .cell-code}\nitem_frequency <- \n  full_join(\n    train %>% group_by(item) %>% count() %>% ungroup(),\n    test  %>% group_by(item) %>% count() %>% ungroup(),\n    by = \"item\"\n  ) %>%\n  rename(count_train = n.x, count_test = n.y) %>%\n  replace_na(list(count_train = 0, count_test = 0))\n```\n:::\n\n::: {.cell}\n::: {.cell-output-display}\n```{=html}\n<div id=\"ehcizdhnqn\" style=\"padding-left:0px;padding-right:0px;padding-top:10px;padding-bottom:10px;overflow-x:auto;overflow-y:auto;width:auto;height:auto;\">\n<style>html {\n  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Helvetica Neue', 'Fira Sans', 'Droid Sans', Arial, sans-serif;\n}\n\n#ehcizdhnqn .gt_table {\n  display: table;\n  border-collapse: collapse;\n  margin-left: auto;\n  margin-right: auto;\n  color: #333333;\n  font-size: 16px;\n  font-weight: normal;\n  font-style: normal;\n  background-color: #FFFFFF;\n  width: auto;\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #A8A8A8;\n  border-right-style: none;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #A8A8A8;\n  border-left-style: none;\n  border-left-width: 2px;\n  border-left-color: #D3D3D3;\n}\n\n#ehcizdhnqn .gt_heading {\n  background-color: #FFFFFF;\n  text-align: center;\n  border-bottom-color: #FFFFFF;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n}\n\n#ehcizdhnqn .gt_caption {\n  padding-top: 4px;\n  padding-bottom: 4px;\n}\n\n#ehcizdhnqn .gt_title {\n  color: #333333;\n  font-size: 125%;\n  font-weight: initial;\n  padding-top: 4px;\n  padding-bottom: 4px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-bottom-color: #FFFFFF;\n  border-bottom-width: 0;\n}\n\n#ehcizdhnqn .gt_subtitle {\n  color: #333333;\n  font-size: 85%;\n  font-weight: initial;\n  padding-top: 0;\n  padding-bottom: 6px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-top-color: #FFFFFF;\n  border-top-width: 0;\n}\n\n#ehcizdhnqn .gt_bottom_border {\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n}\n\n#ehcizdhnqn .gt_col_headings {\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n}\n\n#ehcizdhnqn .gt_col_heading {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: normal;\n  text-transform: inherit;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n  vertical-align: bottom;\n  padding-top: 5px;\n  padding-bottom: 6px;\n  padding-left: 5px;\n  padding-right: 5px;\n  overflow-x: hidden;\n}\n\n#ehcizdhnqn .gt_column_spanner_outer {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: normal;\n  text-transform: inherit;\n  padding-top: 0;\n  padding-bottom: 0;\n  padding-left: 4px;\n  padding-right: 4px;\n}\n\n#ehcizdhnqn .gt_column_spanner_outer:first-child {\n  padding-left: 0;\n}\n\n#ehcizdhnqn .gt_column_spanner_outer:last-child {\n  padding-right: 0;\n}\n\n#ehcizdhnqn .gt_column_spanner {\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  vertical-align: bottom;\n  padding-top: 5px;\n  padding-bottom: 5px;\n  overflow-x: hidden;\n  display: inline-block;\n  width: 100%;\n}\n\n#ehcizdhnqn .gt_group_heading {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  text-transform: inherit;\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n  vertical-align: middle;\n  text-align: left;\n}\n\n#ehcizdhnqn .gt_empty_group_heading {\n  padding: 0.5px;\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  vertical-align: middle;\n}\n\n#ehcizdhnqn .gt_from_md > :first-child {\n  margin-top: 0;\n}\n\n#ehcizdhnqn .gt_from_md > :last-child {\n  margin-bottom: 0;\n}\n\n#ehcizdhnqn .gt_row {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  margin: 10px;\n  border-top-style: solid;\n  border-top-width: 1px;\n  border-top-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n  vertical-align: middle;\n  overflow-x: hidden;\n}\n\n#ehcizdhnqn .gt_stub {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  text-transform: inherit;\n  border-right-style: solid;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#ehcizdhnqn .gt_stub_row_group {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  text-transform: inherit;\n  border-right-style: solid;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n  padding-left: 5px;\n  padding-right: 5px;\n  vertical-align: top;\n}\n\n#ehcizdhnqn .gt_row_group_first td {\n  border-top-width: 2px;\n}\n\n#ehcizdhnqn .gt_summary_row {\n  color: #333333;\n  background-color: #FFFFFF;\n  text-transform: inherit;\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#ehcizdhnqn .gt_first_summary_row {\n  border-top-style: solid;\n  border-top-color: #D3D3D3;\n}\n\n#ehcizdhnqn .gt_first_summary_row.thick {\n  border-top-width: 2px;\n}\n\n#ehcizdhnqn .gt_last_summary_row {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n}\n\n#ehcizdhnqn .gt_grand_summary_row {\n  color: #333333;\n  background-color: #FFFFFF;\n  text-transform: inherit;\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#ehcizdhnqn .gt_first_grand_summary_row {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-top-style: double;\n  border-top-width: 6px;\n  border-top-color: #D3D3D3;\n}\n\n#ehcizdhnqn .gt_striped {\n  background-color: rgba(128, 128, 128, 0.05);\n}\n\n#ehcizdhnqn .gt_table_body {\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n}\n\n#ehcizdhnqn .gt_footnotes {\n  color: #333333;\n  background-color: #FFFFFF;\n  border-bottom-style: none;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 2px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n}\n\n#ehcizdhnqn .gt_footnote {\n  margin: 0px;\n  font-size: 90%;\n  padding-left: 4px;\n  padding-right: 4px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#ehcizdhnqn .gt_sourcenotes {\n  color: #333333;\n  background-color: #FFFFFF;\n  border-bottom-style: none;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 2px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n}\n\n#ehcizdhnqn .gt_sourcenote {\n  font-size: 90%;\n  padding-top: 4px;\n  padding-bottom: 4px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#ehcizdhnqn .gt_left {\n  text-align: left;\n}\n\n#ehcizdhnqn .gt_center {\n  text-align: center;\n}\n\n#ehcizdhnqn .gt_right {\n  text-align: right;\n  font-variant-numeric: tabular-nums;\n}\n\n#ehcizdhnqn .gt_font_normal {\n  font-weight: normal;\n}\n\n#ehcizdhnqn .gt_font_bold {\n  font-weight: bold;\n}\n\n#ehcizdhnqn .gt_font_italic {\n  font-style: italic;\n}\n\n#ehcizdhnqn .gt_super {\n  font-size: 65%;\n}\n\n#ehcizdhnqn .gt_footnote_marks {\n  font-style: italic;\n  font-weight: normal;\n  font-size: 75%;\n  vertical-align: 0.4em;\n}\n\n#ehcizdhnqn .gt_asterisk {\n  font-size: 100%;\n  vertical-align: 0;\n}\n\n#ehcizdhnqn .gt_indent_1 {\n  text-indent: 5px;\n}\n\n#ehcizdhnqn .gt_indent_2 {\n  text-indent: 10px;\n}\n\n#ehcizdhnqn .gt_indent_3 {\n  text-indent: 15px;\n}\n\n#ehcizdhnqn .gt_indent_4 {\n  text-indent: 20px;\n}\n\n#ehcizdhnqn .gt_indent_5 {\n  text-indent: 25px;\n}\n</style>\n<table class=\"gt_table\">\n  \n  <thead class=\"gt_col_headings\">\n    <tr>\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_right\" rowspan=\"1\" colspan=\"1\" scope=\"col\" id=\"item\">item</th>\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_right\" rowspan=\"1\" colspan=\"1\" scope=\"col\" id=\"Train Count\">Train Count</th>\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_right\" rowspan=\"1\" colspan=\"1\" scope=\"col\" id=\"Test Count\">Test Count</th>\n    </tr>\n  </thead>\n  <tbody class=\"gt_table_body\">\n    <tr><td headers=\"item\" class=\"gt_row gt_right\">0</td>\n<td headers=\"count_train\" class=\"gt_row gt_right\">932</td>\n<td headers=\"count_test\" class=\"gt_row gt_right\">5</td></tr>\n    <tr><td headers=\"item\" class=\"gt_row gt_right\">1</td>\n<td headers=\"count_train\" class=\"gt_row gt_right\">77</td>\n<td headers=\"count_test\" class=\"gt_row gt_right\">0</td></tr>\n    <tr><td headers=\"item\" class=\"gt_row gt_right\">2</td>\n<td headers=\"count_train\" class=\"gt_row gt_right\">259</td>\n<td headers=\"count_test\" class=\"gt_row gt_right\">1</td></tr>\n    <tr><td headers=\"item\" class=\"gt_row gt_right\">3</td>\n<td headers=\"count_train\" class=\"gt_row gt_right\">308</td>\n<td headers=\"count_test\" class=\"gt_row gt_right\">2</td></tr>\n    <tr><td headers=\"item\" class=\"gt_row gt_right\">4</td>\n<td headers=\"count_train\" class=\"gt_row gt_right\">309</td>\n<td headers=\"count_test\" class=\"gt_row gt_right\">85</td></tr>\n    <tr><td headers=\"item\" class=\"gt_row gt_right\">5</td>\n<td headers=\"count_train\" class=\"gt_row gt_right\">1186</td>\n<td headers=\"count_test\" class=\"gt_row gt_right\">0</td></tr>\n  </tbody>\n  \n  \n</table>\n</div>\n```\n:::\n:::\n\n\nWe can use this information to re-create the plot from the paper:\n\n\n::: {.cell layout-align=\"center\" code-copy='true'}\n\n```{.r .cell-code  code-fold=\"true\"}\nitem_frequency %>%\n  mutate(train = count_train/max(count_train), test = count_test/max(count_test)) %>%\n  arrange(desc(count_train)) %>%\n  mutate(train_rank = row_number()) %>%\n  select(-count_train, -count_test) %>%\n  pivot_longer(-c(item, train_rank), names_to = \"data\", values_to = \"num_interactions\") %>%\n  ggplot(aes(train_rank, num_interactions, group = data, color = data)) +\n  geom_line() +\n  geom_point() +\n  xlab(\"Item Index\") +\n  ylab(\"Normalized number of interactions\")\n```\n\n::: {.cell-output-display}\n![Figure 1: Comparison of the provided test and train data](index_files/figure-html/unnamed-chunk-8-1.png){fig-align='center' width=672}\n:::\n:::\n\n\nI think that looks pretty close to the image in the article! As the authors point out, the items are sorted by their popularity in the training set (in descending order along the horizontal axis). The value of the (normalized) test popularity is also plotted for each item. We can see that the two distributions do not look similar. To be a bit more rigorous we can consider a few statistical procedures.\n\n## Gini Index\n\nThe article authors used the Gini index to evaluate the distribution of the provided test set. Let's try it to see how it works. We'll use the [`ineq`](https://CRAN.R-project.org/package=ineq){target=\"_blank\"} R package.\n\n\n::: {.cell code-copy='true'}\n\n```{.r .fold-show .cell-code}\n#install.packages(\"ineq\")\nlibrary(ineq)\n```\n:::\n\n\nThe Gini index is a measure of inequality ranging from 0 (equality) to 1 (no equality). For example, if there were no popularity bias in the dataset (i.e. all items had the same number of interactions), then the Gini index would be 0. That's not the case since some movies were watched more than others. Let's look at the Gini index for the provided train and test sets.\n\n\n::: {.cell code-copy='true'}\n\n```{.r .fold-show .cell-code}\n# Gini index for provided test set\ngini_provided_test <- \n  item_frequency %>% \n  select(-item, -count_train) %>%\n  as.matrix() %>%\n  ineq(type=\"Gini\")\n\n# Gini index for provided train set\ngini_provided_train <- \n  item_frequency %>% \n  select(-item, -count_test) %>%\n  as.matrix() %>%\n  ineq(type=\"Gini\")\n\ngini_provided_train\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] 0.7636983\n```\n:::\n\n```{.r .fold-show .cell-code}\ngini_provided_test\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] 0.9044503\n```\n:::\n:::\n\n\nThe provided test set has a much higher Gini index than the train dataset (0.9 compared to 0.76). Is such a difference expected for a random train/test split? Keep reading.\n\n## Resampling the test data\n\nLet's try sampling our own test set to see how that affects the Gini index. We'll start with the full dataset, sampling user-item interactions at the same rate as the provided train/test split and stratifying by user.\n\n\n::: {.cell code-copy='true'}\n\n```{.r .fold-show .cell-code}\n# Determine percentage of data that should be sampled for test\n(pct_test <- nrow(test)/(nrow(test) + nrow(train)))\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] 0.2081349\n```\n:::\n:::\n\n::: {.cell code-copy='true'}\n\n```{.r .fold-show .cell-code}\n# Sample test set (stratify by user)\ndata_full <- bind_rows(train,test)\ntest_new <- \n  data_full %>% \n  group_by(user) %>%\n  slice_sample(prop = pct_test) %>%\n  ungroup()\n\n# Put remaining data in train:\ntrain_new <- anti_join(data_full, test_new)\n\n# Recreate our interaction counts for each item:\nitem_frequency_new <- \n  full_join(\n    train_new %>% group_by(item) %>% count() %>% ungroup(),\n    test_new  %>% group_by(item) %>% count() %>% ungroup(),\n    by = \"item\"\n  ) %>%\n  rename(count_train = n.x, count_test = n.y) %>%\n  replace_na(list(count_train = 0, count_test = 0))\n```\n:::\n\n\nLet's visualize the newly sampled train and test data, which we can compare to Figure 1.\n\n\n\n::: {.cell layout-align=\"center\" code-copy='true'}\n\n```{.r .cell-code  code-fold=\"true\"}\nitem_frequency_new %>%\n  mutate(train = count_train/max(count_train), test = count_test/max(count_test)) %>%\n  arrange(desc(count_train)) %>%\n  mutate(train_rank = row_number()) %>%\n  select(-count_train, -count_test) %>%\n  pivot_longer(-c(item, train_rank), names_to = \"data\", values_to = \"num_interactions\") %>%\n  ggplot(aes(train_rank, num_interactions, group = data, color = data)) +\n  geom_line() +\n  geom_point() +\n  xlab(\"Items\") +\n  ylab(\"Normalized number of interactions\")\n```\n\n::: {.cell-output-display}\n![Figure 2: Comparison of our sampled test and train data](index_files/figure-html/unnamed-chunk-13-1.png){fig-align='center' width=672}\n:::\n:::\n\n\n\nThe test and train popularity distributions look much closer!\n\n## Gini Index Revisited\n\nNow we can revisit the Gini index for the re-sampled train/test split.\n\n\n::: {.cell code-copy='true'}\n\n```{.r .fold-show .cell-code}\n# Gini index for our sampled test set:\ngini_ours_test <- \n  item_frequency_new %>% \n  select(-item, -count_train) %>%\n  as.matrix() %>%\n  ineq(type=\"Gini\")\ngini_ours_test\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] 0.7553342\n```\n:::\n\n```{.r .fold-show .cell-code}\n# Gini index for our sampled train set:\ngini_ours_train <- \n  item_frequency_new %>% \n  select(-item, -count_test) %>%\n  as.matrix() %>%\n  ineq(type=\"Gini\")\n\ngini_ours_train\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] 0.7509054\n```\n:::\n:::\n\n\nWe see that our sampled test set has a Gini index (0.76) that is much closer to that of our sampled training dataset (0.75).\n\nBut, how much difference can we expect between the two sampled datasets that are representative of the same distribution? Is the observed difference in the provided datasets likely due to random sampling or some other reason? Let's take a look at a couple of hypothesis tests.\n\n## Hypothesis Testing\n\n### $\\chi^2$ Test of Homogeneity\n\n<!-- ### $\\chi^2$ Goodness of Fit Test -->\n\nLet's suppose that our null hypothesis is that the train and test sets have the *same* underlying distribution (vs the alternative hypothesis that they do not). We can consider the data as a 2 by 3232 contingency table (since there are 3232 items). One might naively choose to run a $\\chi^2$ test to test this hypothesis.\n\n<!-- Let's suppose that our null hypothesis is that the test set is representative of the full dataset (vs the alternative hypothesis that it is not). We can consider the data as a 2 by 3232 contingency table (since there are 3232 items). -->\n\n<!-- One might naively choose to run a $\\chi^2$ test to test this hypothesis.  -->\n\nThe $\\chi^2$ test is most appropriate when the data is not too sparse. Recall that one of the rule-of-thumb assumptions for the $\\chi^2$ test is that no more than 20% of the expected cells counts are less than 5. <!-- (Sometimes a slightly different rule of thumb is used: that *all* cell counts have an expected value of *at least* 5.)  -->\\\nLet's check to see if this assumption is satisfied.\n\n\n::: {.cell code-copy='true'}\n\n```{.r .fold-show .cell-code}\n# Check to see percentage of expected cell values are < 5\n\n# Compute the expected values\nn_train <- sum(item_frequency$count_train)\nn_test <- sum(item_frequency$count_test) \nn <- n_train + n_test\nitem_frequency %<>% \n  mutate(p = (count_train + count_test)/n,\n         e_test = p * n_test,\n         e_train = p * n_train)\n\n# Check what percentage of the expected values are less than 5\n(pct_expected_small <- sum((item_frequency$e_test < 5) + (item_frequency$e_test < 5))/(2*nrow(item_frequency)))\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] 0.5792079\n```\n:::\n:::\n\n\nWe see here that 57.9% of the expected values are very small (less than 5), meaning that the assumption in question is **not** satisfied.\n\n<!-- In addition to this issue, the test and train vectors are not independent. (The test/train split is a random partition of the full dataset. The data assigned to one of the sets is dependent on the data that is sampled for the other.) Independence is another assumption for the $\\chi^2$ test. -->\n\nLet's look at an alternative method.\n\n### Fisher's Exact Test\n\nAgain consider a 2 by 3232 contingency table composed of the test and train vectors. We can utilize a test that is acceptable for small sample sizes: Fisher's exact test can be used to test the null hypothesis that the two factors of a 2-dimensional contingency table are independent (no relationship) vs the alternative that they are not.\n\nConsider first Fisher's exact test for the original train/test data:\n\n\n::: {.cell code-copy='true'}\n\n```{.r .cell-code}\nitem_frequency %>% \n  select(count_train, count_test) %>% \n  fisher.test(simulate.p.value = TRUE)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n\n\tFisher's Exact Test for Count Data with simulated p-value (based on\n\t2000 replicates)\n\ndata:  .\np-value = 0.0004998\nalternative hypothesis: two.sided\n```\n:::\n:::\n\n\nThe p-value is very small indicating that there is sufficient evidence that movie popularity is dependent on the dataset (test or train).\n\nNow consider Fisher's exact test for our re-sampled train/test data:\n\n\n::: {.cell code-copy='true'}\n\n```{.r .cell-code}\nitem_frequency_new %>% \n  select(count_train, count_test) %>% \n  fisher.test(simulate.p.value = TRUE)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n\n\tFisher's Exact Test for Count Data with simulated p-value (based on\n\t2000 replicates)\n\ndata:  .\np-value = 0.09595\nalternative hypothesis: two.sided\n```\n:::\n:::\n\n\nIn this case the p-value is large meaning that we fail to reject the null hypothesis that movie popularity is independent of the dataset. In other words, we see a similar popularity pattern in both the test and train data sets that we sampled. These results align with our expectation.\n\n<!-- ### Hypothesis testing of high dimensional (and sparse) discrete data -->\n\n<!-- In a [previous blog post](https://amanda.rbind.io/2019/05/24/new-r-package-hddtest/){target=\"_blank\"} I introduced a new method for testing whether two high dimensional mutlinomial vectors have the same underlying probability vector. Compared to the $\\chi^2$ test, this method is more robust in the presence of small values. The R method is available via the `hddtest` package available in the [AmandaRP/hddtest](https://github.com/AmandaRP/hddtest){target=\"_blank\"} GitHub repository. -->\n\n<!-- ```{r class.source = \"fold-show\"} -->\n\n<!-- #devtools::install_github(\"AmandaRP/hddtest\", build = TRUE, build_opts = c(\"--no-resave-data\", \"--no-manual\")) -->\n\n<!-- library(\"hddtest\") -->\n\n<!-- ``` -->\n\n<!-- We'll assume that the train and test vectors have an underlying multinomial distribution with parameters ($p_{train}$, $n_{train}$) and ($p_{test}$, $n_{test}$) respectively. (See the [Closing Thoughts](#closing) section at the end for a discussion about the multinomial assumption.) We'd like to test the null hypothesis that $p_{train} = p_{test}$ vs the althernative that they are not equal. To do this we might consider using the `multinom.test` function from the `hddtest` package. However, a simulation experiment shows that the [size](https://en.wikipedia.org/wiki/Size_(statistics)) of the test is not well controlled when the data is stratified by user (see the Appendix at the end of the article). In other words, the test is too sensitive.  -->\n\n<!-- Alternatively, we can consider the null hypothesis that $p_{train}$ and $p_{test}$ are within some neighborhood, $\\delta$ (vs the alternative that they are not). What value of $\\delta$ should be used? Figure 3 below shows the p-value curves for various values of $\\delta$, comparing multiple random test/train splits (teal) and also the provided test & train data (red). We won't actually perform the hypothesis test because we've now peaked at our data. However, you can see that the p-value curve for the provided data looks much different than those for the random test/train splits. -->\n\n<!-- <details> -->\n\n<!--   <summary>View code</summary> -->\n\n<!-- </br>  -->\n\n<!-- ```{r, fig.width=8, fig.height=3.5, message = FALSE, warning=FALSE, echo = TRUE, eval = FALSE, fig.cap='Delta in (0, 2800]. Inset image: Zoomed view of delta in (0, 5].'} -->\n\n<!-- num_reps <- 50 -->\n\n<!-- stratified <- TRUE -->\n\n<!-- vecs2Test <- list(matrix(NA, num_reps, nrow(item_frequency)), matrix(NA, num_reps, nrow(item_frequency))) -->\n\n<!-- for(i in 1:num_reps){ -->\n\n<!--   if(stratified){ -->\n\n<!--     test_sim <-  -->\n\n<!--       data_full %>%  -->\n\n<!--       group_by(user) %>% -->\n\n<!--       slice_sample(prop = pct_test) %>% -->\n\n<!--       ungroup() -->\n\n<!--   }else{ -->\n\n<!--     test_sim <-  -->\n\n<!--       data_full %>%  -->\n\n<!--       slice_sample(prop = pct_test)  -->\n\n<!--   } -->\n\n<!--   # Put remaining data in train: -->\n\n<!--   train_sim <- anti_join(data_full, test_sim) -->\n\n<!--   # Recreate our interaction counts for each item: -->\n\n<!--   item_frequency_sim <-  -->\n\n<!--     full_join( -->\n\n<!--       train_sim %>% group_by(item) %>% count() %>% ungroup(), -->\n\n<!--       test_sim  %>% group_by(item) %>% count() %>% ungroup(), -->\n\n<!--       by = \"item\" -->\n\n<!--     ) %>% -->\n\n<!--     rename(count_train = n.x, count_test = n.y) %>% -->\n\n<!--     replace_na(list(count_train = 0, count_test = 0)) -->\n\n<!--   # Build a matrix of vectors to test -->\n\n<!--   vecs2Test[[1]][i, ] <- item_frequency_sim$count_train -->\n\n<!--   vecs2Test[[2]][i, ] <- item_frequency_sim$count_test -->\n\n<!-- } -->\n\n<!-- #Perform the test: -->\n\n<!-- delta = c(.00000001, .00001, .0001, .001, .01, .1, .5, .75, seq(from=1,to=2800, by = 100) ) -->\n\n<!-- result_sampled <- vecs2Test %>% multinom.neighborhood.test(delta = delta) -->\n\n<!-- p_sampled <- result_sampled$pvalue_delta -->\n\n<!-- result_original <- multinom.neighborhood.test(x = item_frequency$count_train, y = item_frequency$count_test, delta = delta) -->\n\n<!-- p_original <- result_original$pvalue_delta -->\n\n<!-- dat1 <- data.frame(delta=delta, sampled = t(p_sampled), original = t(p_original)) %>% -->\n\n<!--   gather(-delta, key = \"replication\", value = pvalue) %>%  -->\n\n<!--   mutate(\"hypothesis\" = str_extract(replication,\"\\\\w{1,}\")) -->\n\n<!-- p1 <- ggplot(dat1, aes(x = delta, y = pvalue, group = replication, colour = hypothesis)) +  -->\n\n<!--   geom_line() + -->\n\n<!--   geom_hline(yintercept = 0.05, linetype = \"dotted\") + -->\n\n<!--   annotate(\"text\", x = 300, y = .09, label = \"alpha = 0.05\") + -->\n\n<!--   labs(y = \"p-value\", title = \"P-Value Curves for Original and Sampled Train/Test Splits\", color = \"Dataset\") +  -->\n\n<!--   #geom_curve(aes(x = 75, y = .71, xend = 61, yend = .6), curvature = -0.3, arrow = arrow(length=unit(2,\"mm\")), color = \"darkgrey\") + -->\n\n<!--   theme_classic() + -->\n\n<!--   theme(title = element_text(face = \"bold\", size = 14), -->\n\n<!--         panel.grid = element_blank()) -->\n\n<!-- delta = c(.00000001, .00001, .0001, .001, .01, .1, .5, .75, 1:5) -->\n\n<!-- result_sampled <- vecs2Test %>% multinom.neighborhood.test(delta = delta) -->\n\n<!-- p_sampled <- result_sampled$pvalue_delta -->\n\n<!-- result_original <- multinom.neighborhood.test(x = item_frequency$count_train, y = item_frequency$count_test, delta = delta) -->\n\n<!-- p_original <- result_original$pvalue_delta -->\n\n<!-- dat2 <- data.frame(delta=delta, sampled = t(p_sampled), original = t(p_original)) %>% -->\n\n<!--   gather(-delta, key = \"replication\", value = pvalue) %>%  -->\n\n<!--   mutate(\"hypothesis\" = str_extract(replication,\"\\\\w{1,}\")) -->\n\n<!-- p2 <- ggplot(dat2, aes(x = delta, y = pvalue, group = replication, colour = hypothesis)) +  -->\n\n<!--   geom_line() + -->\n\n<!--   labs(y = element_blank()) +  -->\n\n<!--   #geom_curve(aes(x = 75, y = .71, xend = 61, yend = .6), curvature = -0.3, arrow = arrow(length=unit(2,\"mm\")), color = \"darkgrey\") + -->\n\n<!--   theme_classic() + -->\n\n<!--   theme(title = element_text(face = \"bold\", size = 14), -->\n\n<!--         panel.grid = element_blank(), -->\n\n<!--         legend.title = element_blank(), -->\n\n<!--         legend.position = \"none\" -->\n\n<!--         ) -->\n\n<!-- ggdraw(p1) + -->\n\n<!--   draw_plot(p2, .25, .25, .4, .5)  -->\n\n<!-- ``` -->\n\n<!-- </details> -->\n\n<!-- ```{r, fig.width=8, fig.height=3.5, message = FALSE, warning=FALSE, echo = FALSE, fig.cap='Delta in (0, 2800]. Inset image: Zoomed view of delta in (0, 5].'} -->\n\n<!-- num_reps <- 50 -->\n\n<!-- stratified <- TRUE -->\n\n<!-- vecs2Test <- list(matrix(NA, num_reps, nrow(item_frequency)), matrix(NA, num_reps, nrow(item_frequency))) -->\n\n<!-- for(i in 1:num_reps){ -->\n\n<!--   if(stratified){ -->\n\n<!--     test_sim <-  -->\n\n<!--       data_full %>%  -->\n\n<!--       group_by(user) %>% -->\n\n<!--       slice_sample(prop = pct_test) %>% -->\n\n<!--       ungroup() -->\n\n<!--   }else{ -->\n\n<!--     test_sim <-  -->\n\n<!--       data_full %>%  -->\n\n<!--       slice_sample(prop = pct_test)  -->\n\n<!--   } -->\n\n<!--   # Put remaining data in train: -->\n\n<!--   train_sim <- anti_join(data_full, test_sim) -->\n\n<!--   # Recreate our interaction counts for each item: -->\n\n<!--   item_frequency_sim <-  -->\n\n<!--     full_join( -->\n\n<!--       train_sim %>% group_by(item) %>% count() %>% ungroup(), -->\n\n<!--       test_sim  %>% group_by(item) %>% count() %>% ungroup(), -->\n\n<!--       by = \"item\" -->\n\n<!--     ) %>% -->\n\n<!--     rename(count_train = n.x, count_test = n.y) %>% -->\n\n<!--     replace_na(list(count_train = 0, count_test = 0)) -->\n\n<!--   # Build a matrix of vectors to test -->\n\n<!--   vecs2Test[[1]][i, ] <- item_frequency_sim$count_train -->\n\n<!--   vecs2Test[[2]][i, ] <- item_frequency_sim$count_test -->\n\n<!-- } -->\n\n<!-- #Perform the test: -->\n\n<!-- delta = c(.00000001, .00001, .0001, .001, .01, .1, .5, .75, seq(from=1,to=2800, by = 100) ) -->\n\n<!-- result_sampled <- vecs2Test %>% multinom.neighborhood.test(delta = delta) -->\n\n<!-- p_sampled <- result_sampled$pvalue_delta -->\n\n<!-- result_original <- multinom.neighborhood.test(x = item_frequency$count_train, y = item_frequency$count_test, delta = delta) -->\n\n<!-- p_original <- result_original$pvalue_delta -->\n\n<!-- dat1 <- data.frame(delta=delta, sampled = t(p_sampled), original = t(p_original)) %>% -->\n\n<!--   gather(-delta, key = \"replication\", value = pvalue) %>%  -->\n\n<!--   mutate(\"hypothesis\" = str_extract(replication,\"\\\\w{1,}\")) -->\n\n<!-- p1 <- ggplot(dat1, aes(x = delta, y = pvalue, group = replication, colour = hypothesis)) +  -->\n\n<!--   geom_line() + -->\n\n<!--   geom_hline(yintercept = 0.05, linetype = \"dotted\") + -->\n\n<!--   annotate(\"text\", x = 300, y = .09, label = \"alpha = 0.05\") + -->\n\n<!--   labs(y = \"p-value\", title = \"P-Value Curves for Original and Sampled Train/Test Splits\", color = \"Dataset\") +  -->\n\n<!--   #geom_curve(aes(x = 75, y = .71, xend = 61, yend = .6), curvature = -0.3, arrow = arrow(length=unit(2,\"mm\")), color = \"darkgrey\") + -->\n\n<!--   theme_classic() + -->\n\n<!--   theme(title = element_text(face = \"bold\", size = 14), -->\n\n<!--         panel.grid = element_blank()) -->\n\n<!-- delta = c(.00000001, .00001, .0001, .001, .01, .1, .5, .75, 1:5) -->\n\n<!-- result_sampled <- vecs2Test %>% multinom.neighborhood.test(delta = delta) -->\n\n<!-- p_sampled <- result_sampled$pvalue_delta -->\n\n<!-- result_original <- multinom.neighborhood.test(x = item_frequency$count_train, y = item_frequency$count_test, delta = delta) -->\n\n<!-- p_original <- result_original$pvalue_delta -->\n\n<!-- dat2 <- data.frame(delta=delta, sampled = t(p_sampled), original = t(p_original)) %>% -->\n\n<!--   gather(-delta, key = \"replication\", value = pvalue) %>%  -->\n\n<!--   mutate(\"hypothesis\" = str_extract(replication,\"\\\\w{1,}\")) -->\n\n<!-- p2 <- ggplot(dat2, aes(x = delta, y = pvalue, group = replication, colour = hypothesis)) +  -->\n\n<!--   geom_line() + -->\n\n<!--   labs(y = element_blank()) +  -->\n\n<!--   #geom_curve(aes(x = 75, y = .71, xend = 61, yend = .6), curvature = -0.3, arrow = arrow(length=unit(2,\"mm\")), color = \"darkgrey\") + -->\n\n<!--   theme_classic() + -->\n\n<!--   theme(title = element_text(face = \"bold\", size = 14), -->\n\n<!--         panel.grid = element_blank(), -->\n\n<!--         legend.title = element_blank(), -->\n\n<!--         legend.position = \"none\" -->\n\n<!--         ) -->\n\n<!-- ggdraw(p1) + -->\n\n<!--   draw_plot(p2, .25, .25, .4, .5)  -->\n\n<!-- ``` -->\n\n## Closing Thoughts {#closing}\n\nUsing a few methods (vizualization, Gini index, and hypothesis testing) we observed that the provided test data set did not follow the same popularity distribution as the training set.\n\nAnother scenario to consider: Should we always expect our train and test data to have the same distribution? What if the test/train split were based on time (i.e. we use earlier data to train the model and use the most recent data to test). How much difference is acceptable? After all, movie popularity changes over time (thinking about our particular application). This might be an interesting topic for a future blog post.\n\n<!-- One might also argue that we should not assume a multinomial distribution for the item counts as we did for the hypothesis testing. If there is correlation between the items (e.g. if the first movie in a series was popular, we might expect the sequel to also do well), then the Dirichlet-multinomial distribution may be a better assumption. In this case, a different hypothesis tests is required. -->\n\nIf you would like to provide feedback on this blog post, you can contact me via Twitter (@DrAmandaRP). Thanks for reading!\n\n<!-- <details> -->\n\n<!--   <summary>**Appendix**: Size Study</summary> -->\n\n<!-- To understand the size of the hypothesis test (i.e. the `multinom.test` from the `hddtest` package) for the application of comparing the test and training datasets, let's run a simulation sampling mulitple test/train splits.  -->\n\n<!-- ```{r eval = FALSE, class.source = 'fold-show'} -->\n\n<!-- data_full_sim <- data_full -->\n\n<!-- alpha <- 0.05 -->\n\n<!-- num_reps <- 10000 -->\n\n<!-- stratified <- FALSE -->\n\n<!-- result <- array(NA, dim = num_reps) -->\n\n<!-- for(i in 1:num_reps){ -->\n\n<!--   if(stratified){ -->\n\n<!--     test_sim <-  -->\n\n<!--       data_full_sim %>%  -->\n\n<!--       group_by(user) %>% -->\n\n<!--       slice_sample(prop = pct_test) %>% -->\n\n<!--       ungroup() -->\n\n<!--   }else{ -->\n\n<!--     test_sim <-  -->\n\n<!--       data_full_sim %>%  -->\n\n<!--       slice_sample(prop = pct_test)  -->\n\n<!--   } -->\n\n<!--   # Put remaining data in train: -->\n\n<!--   train_sim <- anti_join(data_full_sim, test_sim) -->\n\n<!--   # Recreate our interaction counts for each item: -->\n\n<!--   item_frequency_sim <-  -->\n\n<!--     full_join( -->\n\n<!--       train_sim %>% group_by(item) %>% count() %>% ungroup(), -->\n\n<!--       test_sim  %>% group_by(item) %>% count() %>% ungroup(), -->\n\n<!--       by = \"item\" -->\n\n<!--     ) %>% -->\n\n<!--     rename(count_train = n.x, count_test = n.y) %>% -->\n\n<!--     replace_na(list(count_train = 0, count_test = 0)) -->\n\n<!--   result[i] <- multinom.test(item_frequency_sim$count_train, item_frequency_sim$count_test)$pvalue  -->\n\n<!-- } -->\n\n<!-- mean(result <= alpha) -->\n\n<!-- # size for stratified data: 0.2351 (using 10K reps). Not controlling size well.  -->\n\n<!-- # size for non-stratified data: 0.0517 (using 10K reps) -->\n\n<!-- ``` -->\n\n<!-- Using 10K replications and $\\alpha = 0.05$, the size of the test on the stratified sampled data is 0.2351 (not well controlled). However, the size of the test for the non-stratified sampled data is 0.0517, which is much better. In other words, the test is too sensitive for the stratified sampled dataset. -->\n\n<!-- </details>  -->\n",
    "supporting": [
      "index_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}